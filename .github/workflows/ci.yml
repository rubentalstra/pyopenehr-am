name: CI

on:
    push:
    pull_request:

permissions:
    contents: read

concurrency:
    group: ci-${{ github.ref }}
    cancel-in-progress: true

jobs:
    quality:
        name: ruff + pyright + pytest (py3.14)
        runs-on: ubuntu-latest

        env:
            PIP_DISABLE_PIP_VERSION_CHECK: "1"
            PYTHONUTF8: "1"

        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Set up Python
              uses: actions/setup-python@v6
              with:
                  python-version: "3.14"
                  cache: pip
                  cache-dependency-path: pyproject.toml

            - name: Install
              run: |
                  python -m pip install --upgrade pip
                  python -m pip install -e ".[dev]"

            - name: Generated parser drift check
              run: |
                  python scripts/generate_parsers.py
                  git diff --exit-code

            - name: Ruff format
              run: python -m ruff format --check .

            - name: Ruff lint
              run: |
                  python -m ruff check --fix .
                  git diff --exit-code

            - name: Type check (pyright)
              run: pyright

            - name: Tests
              run: pytest -q
